<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8>
    <title>中医数据采集-管理端</title>
    <style>
        .inline-container>* {
            display: inline-block;
        }

        #header {
            text-align: right;
            padding: 10px;
            display: inline-block;
        }

        #content {
            float: left;
            width: 80%;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #e7f3fe;
        }

        .icon-button {
            /* padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer; */
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            color: #fff;
            background: linear-gradient(to bottom, #4e9cff, #0046ff);
            border-radius: 25px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: background 0.3s ease;
        }

        .icon-button:hover {
            /* background-color: #0056b3; */
            background: linear-gradient(to bottom, #63b8ff, #005eff);
        }

        #generated-form {
            display: none;
        }

        /* 设置导航栏样式 */
        .navbar {
            background-color: #333;
            overflow: hidden;
        }

        /* 设置导航链接样式 */
        .navbar a {
            float: left;
            color: #fff;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }

        /* 设置鼠标悬停时导航链接的样式 */
        .navbar a:hover {
            background-color: #ddd;
            color: #000;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .personal-info,
        .other-info {
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
        }

        .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        label {
            width: 100px;
            font-weight: bold;
        }

        input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* 个人信息相关 */
        .personal-info {
            display: flex;
            flex-direction: column;
        }

        .personal-info span {
            margin-bottom: 10px;
        }

        .personal-info span:first-child {
            margin-bottom: 0;
        }

        /* 诊断信息 */
        .inquiry_info {
            position: relative;
        }

        .inquiry_info input[type="text"] {
            width: 600px;
            height: 100px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: vertical;
        }
    </style>
</head>

<body>
    <noscript><strong>We're sorry but 中医数据采集-管理端 doesn't work properly without JavaScript enabled. Please enable it
            to continue.</strong></noscript>
    <div id="header">
        <span id="welcome"></span>
        <button class="icon-button" onclick="changePassword()">
            <width="20" height="20"> 修改密码
        </button>
        <button class="icon-button" onclick="logout()">
            <width="20" height="20"> 退出登录
        </button>
    </div>

    <div class="navbar">
        <a href="#/home" onclick="clear()">首页</a>
        <a href="#" onclick="addPatient()">添加患者</a>
        <a href="#/todayrecords" onclick="getTodayList('records/getTodayUserList?pageIndex=0&pageSize=10')">今日患者</a>
        <a href="#/records" onclick="getRecordsList('records/getRecordList?pageIndex=0&pageSize=10')">诊断记录</a>
    </div>

    <div id="data-container">
    </div>

    <script>
        var todayRecordHeader = ['序号', '操作', '就诊ID', '患者姓名', '患者ID', '手机号', '接诊时间', '诊断时间'];
        var RecordListHeader = ['序号', '操作', '就诊ID', '患者姓名', '患者ID', '接诊时间', '诊断时间'];
        var fieldMap = {
            "面诊": "faceDiagnose",
            "舌诊": "tongueDiagnose",
            "脉诊": "pulseDiagnose",
            "医生主诉": "doctorChiefComplaint",
            "诊断结果": "medicalResult",
            "治疗方案": "treatment",
            "备注": "remark",
        };

        function loadDoctorName() {
            sendHttpRequest("doctors/getDoctorName", loadName, []);
        }

        function loadName(responseText) {
            var data = responseText;
            try {
                data = JSON.parse(responseText);
            } catch (error) {

            }
            var nameBox = document.getElementById("welcome");
            nameBox.innerText = data["医生姓名"];
        }

        loadDoctorName();

        function changePassword() {
            var newPassword = prompt('输入新密码');

            if (newPassword) {
                body = generateHttpPostBody("doctorPassword=" + newPassword);
                sendHttpRequest("doctors/updateDoctorPassword", null, [], "POST", "application/x-www-form-urlencoded", body)
                    .then(function (result) {
                        logout();
                    })
                    .catch(function (error) {
                        alert("修改失败")
                    });
            }
        }

        function logout() {
            sendHttpRequest("doctors/logout", reloadLogin, [], "GET", 'text/html', "");
        }

        function reloadLogin(responseText) {
            document.open();
            document.write(responseText);
            document.close();
        }

        function getTodayList(url) {
            var thead = createTableHeader(todayRecordHeader);
            sendHttpRequest(url, generateTable, todayRecordHeader)
                .then(function (result) {
                    let currentUrl = window.location.href;
                    history.replaceState(null, null, currentUrl.split("#")[0] + "#/todayrecords");
                })
                .catch(function (error) {

                });
        }

        function getRecordsList(url) {
            var thead = createTableHeader(RecordListHeader);
            sendHttpRequest(url, generateTable, RecordListHeader)
                .then(function (result) {
                    let currentUrl = window.location.href;
                    history.replaceState(null, null, currentUrl.split("#")[0] + "#/records");
                })
                .catch(function (error) {

                });
        }

        function getRecord(url) {
            sendHttpRequest(url, displayRecord, [])
                .then(function (result) {
                    let currentUrl = window.location.href;
                    var IDSpan = document.getElementById("receptionId");
                    history.replaceState(null, null, currentUrl + "/" + IDSpan.innerText.split(": ")[1]);
                })
                .catch(function (error) {
                    alert("获取失败");
                });
        }

        function updateRecord(url) {
            var parentDiv = document.getElementById('userDetail');
            var inputElements = parentDiv.getElementsByTagName('input');
            var bodys = [];
            for (var i = 0; i < inputElements.length; i++) {
                if (inputElements[i].id !== "") {
                    bodys.push(inputElements[i].id + "=" + inputElements[i].value);
                }
            }
            body = generateHttpPostBody.apply(null, bodys);
            sendHttpRequest(url, null, [], "POST", "application/x-www-form-urlencoded", body)
                .then(function (result) {
                    alert("保存成功")
                })
                .catch(function (error) {
                    alert("保存失败")
                });
        }

        function displayRecord(responseText) {
            var data = responseText;
            try {
                data = JSON.parse(responseText);
            } catch (error) {

            }
            var container = document.getElementById("data-container");
            container.innerHTML = "";

            var content = document.createElement("div");
            content.id = "userDetail";
            container.appendChild(content);

            var userinfobox = document.createElement("div");
            content.appendChild(userinfobox);
            userinfobox.classList.add("personal-info");

            var nameSpan = document.createElement("span");
            nameSpan.innerText = data["患者姓名"] + "   ID: " + data["患者ID"];
            var otherSpan = document.createElement("span");
            otherSpan.innerText = data["手机号"];
            userinfobox.appendChild(nameSpan);
            userinfobox.appendChild(otherSpan);

            delete data["患者姓名"];
            delete data["患者ID"];
            delete data["手机号"];

            var diagnosticInfoBox = document.createElement("div");
            content.appendChild(diagnosticInfoBox);
            diagnosticInfoBox.classList.add("personal-info");

            var IDSpan = document.createElement("span");
            IDSpan.innerText = "就诊ID: " + data["就诊ID"];
            IDSpan.id = "receptionId";
            var timeSpan = document.createElement("span");
            timeSpan.innerText = "接诊时间: " + data["接诊时间"];
            var doctorSpan = document.createElement("span");
            doctorSpan.innerText = "诊断医生： " + data["医生姓名"]
            diagnosticInfoBox.appendChild(IDSpan);
            diagnosticInfoBox.appendChild(timeSpan);
            diagnosticInfoBox.appendChild(doctorSpan);

            delete data["就诊ID"];
            delete data["接诊时间"];
            delete data["医生姓名"];

            var infoBox = document.createElement("div");
            diagnosticInfoBox.appendChild(infoBox);

            for (var key in data) {
                var infoDiv = document.createElement("div");
                infoBox.appendChild(infoDiv);
                infoDiv.classList.add("inquiry_info");

                var infoNameDiv = document.createElement("div");
                var infoInput = document.createElement("input");
                infoInput.type = "text";
                if (key == "患者自述") {
                    infoInput.readOnly = true;
                }
                else {
                    infoInput.id = fieldMap[key];
                }

                infoDiv.appendChild(infoNameDiv);
                infoDiv.appendChild(infoInput);

                infoNameDiv.innerText = key;
                infoInput.value = data[key];
            }

            let currentUrl = window.location.href;
            if (currentUrl.split("#")[1] == "/todayrecords") {
                var saveButton = document.createElement("button");
                diagnosticInfoBox.appendChild(saveButton);
                saveButton.innerHTML = "保存";
                saveButton.onclick = function () {
                    const url = window.location.href;
                    const segments = url.split("/");
                    updateRecord("records/updateRecord?receptionId=" + segments.pop());
                };
            }
        }

        function clear() {
            var container = document.getElementById("data-container");
            container.innerHTML = "";
            var divBox = document.createElement("div");
            container.appendChild(divBox);
        }

        function generateHttpPostBody(...params) {
            // 将参数拼接成请求体字符串
            const body = params.join('&');
            return body;
        }

        function sendHttpRequest(url, action, header, method = "GET", contentType = "application/json", body = "") {
            return new Promise(function (resolve, reject) {
                const xhr = new XMLHttpRequest();
                xhr.open(method, `/${url}`);
                xhr.setRequestHeader("Content-Type", contentType);

                xhr.onload = function () {
                    if (xhr.status === 200) {

                        if (action != null) {
                            if (header == []) {
                                action(xhr.responseText);
                            }
                            else {
                                action(xhr.responseText, header);
                            }
                        }
                        resolve(true);

                    }
                    else if (xhr.status === 401) {
                        logout();
                    } 
                    else {
                        console.error('请求失败', xhr.statusText);
                        if (action != null) {

                        }
                        reject(false);
                    }
                };

                xhr.onerror = function () {
                    console.error('请求错误');
                    reject(false);
                };

                if (method == "POST") {
                    xhr.send(body);
                } else {
                    xhr.send();
                }
            });
        }

        function createTableHeader(headerArray) {
            var container = document.getElementById("data-container");
            container.innerHTML = "";

            var table = document.createElement('table');
            container.appendChild(table);
            table.id = 'table';

            var thead = document.createElement('thead');
            var tr = document.createElement('tr');

            headerArray.forEach(function (headerText) {
                var th = document.createElement('th');
                th.textContent = headerText;
                tr.appendChild(th);
            });

            thead.appendChild(tr);
            table.appendChild(thead);

            return table;
        }

        function generateTable(responseText, header) {
            var data = responseText;
            try {
                data = JSON.parse(responseText);
            } catch (error) {

            }
            var table = document.getElementById('table');

            // 创建表格内容
            var tbody = document.createElement('tbody');
            data.forEach(function (obj) {
                var tr = document.createElement('tr');

                header.forEach(function (key) {
                    var td = document.createElement('td');
                    if (obj.hasOwnProperty(key)) {
                        td.textContent = obj[key];
                    }
                    else if (key == "操作") {
                        var button = document.createElement("button");
                        button.innerHTML = "查看";
                        button.onclick = function () {
                            getRecord('records/getRecord?receptionId=' + obj["就诊ID"]);
                        };
                        td.appendChild(button);
                    }
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
        }

        // 打开对话框
        function addPatient() {
            var name = prompt('输入患者ID');

            if (name) {
                body = generateHttpPostBody("patientId=" + name);
                sendHttpRequest("records/addRecord", null, [], "POST", "application/x-www-form-urlencoded", body)
                    .catch(function (error) {
                        alert("用户不存在")
                    });
                getTodayList('records/getTodayUserList?pageIndex=0&pageSize=10');
            }
        }

    </script>

</body>

</html>